pipeline {
    agent {
        docker {
            image 'dussim/build-env:jdk21_gradle-8.9_android-34'
            args '-v gradle-cache:/home/gradle/.gradle --net=host'
        }
    }
    stages {
        stage('Workflow') {
            steps {
                sh 'cat .jenkins/Jenkinsfile'
            }
        }
        stage('Gradle'){
            steps {
                sh 'gradle --version'
                sh 'gradle buildEnvironment'
            }
        }
        stage('Build') {
            steps {
                sh 'gradle :app:assembleInstalledAppDebug --scan'
                recordIssues([
                        enabledForFailure: true,
                        tool             : kotlin()
                ])
                findBuildScans()
            }
        }
        stage('Quality') {
            steps {
                sh 'gradle ktlintCheck --no-build-cache --no-configuration-cache'
                recordIssues([
                        enabledForFailure: true,
                        tool             : ktLint(pattern: '**/build/reports/ktlint/**/*.xml')
                ])
            }
        }
        stage('Versions') {
            steps {
                sh 'gradle dependencyUpdates --no-configure-on-demand --no-configuration-cache --warning-mode=none'
            }
        }
    }
    post {
        success {
            echo 'Archiving artifacts'
            archiveArtifacts([
                    allowEmptyArchive: true,
                    artifacts        : 'app/build/outputs/apk/**/*.apk'
            ])
            archiveArtifacts([
                    allowEmptyArchive: true,
                    artifacts        : '.reports/**/*.html'
            ])
            archiveArtifacts([
                    allowEmptyArchive: true,
                    artifacts        : 'build/reports/**/*.html'
            ])
            publishHTML([
                    allowMissing         : true,
                    alwaysLinkToLastBuild: false,
                    keepAll              : false,
                    reportDir            : '.reports',
                    reportFiles          : '**/*.html',
                    reportName           : 'Aggregated Reports',
            ])
            publishHTML([
                    allowMissing         : true,
                    alwaysLinkToLastBuild: false,
                    keepAll              : false,
                    reportDir            : 'build/reports/',
                    reportFiles          : '**/*.html',
                    reportName           : 'Build Reports',
            ])
        }
    }
}